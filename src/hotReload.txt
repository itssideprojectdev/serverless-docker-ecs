const fs = require('fs');
const path = require('path');
const {S3Client, GetObjectCommand, ListObjectsV2Command} = require('@aws-sdk/client-s3');
const {spawn} = require('child_process');

const s3Client = new S3Client({
  region: 'us-west-2',
});

let currentProcess = null;
const canaryFileName = 'canary.txt';
let currentCanaryContent = '';

async function checkCanaryFile(bucketName) {
  try {
    const getParams = {
      Bucket: bucketName,
      Key: canaryFileName,
    };

    const {Body} = await s3Client.send(new GetObjectCommand(getParams));
    if (Body) {
      const content = await Body.transformToString();
      if (content !== currentCanaryContent) {
        currentCanaryContent = content;
        return true;
      }
    }
    return false;
  } catch (error) {
    console.error('Error checking canary file:', error);
    return false;
  }
}

function killProcess(process) {
  return new Promise((resolve) => {
    if (!process) {
      resolve();
      return;
    }

    process.on('exit', () => {
      resolve();
    });

    process.kill();

    // Fallback: force kill after 5 seconds if the process hasn't exited
    setTimeout(() => {
      if (process.killed === false) {
        console.log('Force killing the process');
        process.kill('SIGKILL');
      }
      resolve();
    }, 5000);
  });
}

async function checkForUpdates() {
  try {
    console.log('Checking for updates');
    let bucketName = 'memoizer-ai' + '-hot-reload';

    const canaryChanged = await checkCanaryFile(bucketName);

    if (canaryChanged) {
      const listParams = {
        Bucket: bucketName,
      };
      console.log('Getting files from S3');

      const listResult = await s3Client.send(new ListObjectsV2Command(listParams));

      if (listResult.Contents) {
        for (const file of listResult.Contents) {
          const getParams = {
            Bucket: bucketName,
            Key: file.Key,
          };

          const {Body} = await s3Client.send(new GetObjectCommand(getParams));
          if (Body) {
            const content = await Body.transformToString();
            const localPath = path.join(process.cwd(), file.Key);
            fs.mkdirSync(path.dirname(localPath), {recursive: true});
            fs.writeFileSync(localPath, content);
          }
        }
      }

      console.log('Files updated from S3');

      if (currentProcess) {
        console.log('Stopping current process');
        await killProcess(currentProcess);
        currentProcess = null;
      }

      console.log('Starting new process');
      currentProcess = spawn('pnpm', ['start'], {stdio: 'inherit'});

      currentProcess.on('exit', (code) => {
        console.log(`Child process exited with code ${code}`);
        currentProcess = null;
      });
    } else {
      console.log('No updates found');
    }
  } catch (error) {
    console.error('Error updating files:', error);
  }
}

// Initial check
checkForUpdates();

// Check every 30 seconds
setInterval(checkForUpdates, 30000);
